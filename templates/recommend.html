<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Recommended Menu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="container">
        <!-- 네비게이션 바 -->
        <nav class="navbar">
            <a href="{{ url_for('recommend') }}"
                class="{% if category == 'recommend' %}active{% endif %}">Recommended</a>
            <a href="{{ url_for('home', category='coffee') }}"
                class="{% if category == 'coffee' %}active{% endif %}">Coffee</a>
            <a href="{{ url_for('home', category='tea') }}" class="{% if category == 'tea' %}active{% endif %}">Tea</a>
            <a href="{{ url_for('home', category='beverage') }}"
                class="{% if category == 'beverage' %}active{% endif %}">Beverage</a>
            <button class="lang-btn" onclick="openLanguageModal()">Language</button>
        </nav>

        <!-- 언어 선택 모달 윈도우 -->
        <div id="languageModal" class="modal">
            <div class="modal-content">
                <h2>Select Language</h2>
                <div class="language-grid">
                    <button onclick="setLanguage('ko')">한국어</button>
                    <button onclick="setLanguage('zh')">中文</button>
                    <button onclick="setLanguage('en')">English</button>
                    <button onclick="setLanguage('ja')">日本語</button>

                </div>
                <button class="back-btn" onclick="closeLanguageModal()">Back</button>
            </div>
        </div>

        <!-- 성별에 따른 추천 메뉴 타이틀 -->
        <h1>{{ "Male's Recommend Menu" if gender == 'male' else "Female's Recommend Menu" }}</h1>
        <p>예측된 감정: {{ emotion }},예측된 연령: {{ age }}, 예측된 성별:{{gender }}</p>
        <p></p>
        <!-- 추천 문구 -->
        <div class="recommendation">

        </div>

        <!-- 메뉴 리스트 -->
        <div class="menu-grid">
            {% for item in menu %}
            <div class="menu-item">
                <img src="{{ url_for('static', filename=item.image) }}" alt="{{ item.name }}" class="item-image">
                <h2 data-name="{{ item.name }}">{{ item.name }}</h2>
                <p data-price="{{ item.price }}">Price: ${{ item.price }}</p>
                <button onclick="addToCart('{{ item.id }}')" class="btn">Add to Cart</button>
            </div>
            {% endfor %}
        </div>

        <!-- 쇼핑 카트와 버튼을 담는 섹션 -->
        <div class="cart-container">
            <div class="cart" id="cart">
                {% include 'cart_partial.html' %}
            </div>
            <!-- 결제 및 취소 버튼 -->
            <div class="action-buttons">
                <button class="payment-btn" onclick="openPaymentModal()">Payment</button>
                <button class="cancel-btn" onclick="window.location.href='/'">Cancel</button>
            </div>
        </div>

        <!-- 결제 모달 윈도우 -->
        <div id="paymentModal" class="modal">
            <div class="modal-content">
                <h2>Select Payment Method</h2>
                <div class="payment-options">
                    <button onclick="alert('Card Payment Selected')">Card Payment</button>
                    <button onclick="alert('Cash Payment Selected')">Cash Payment</button>
                </div>
                <div class="store-options">
                    <button onclick="alert('For Here Selected')">For Here</button>
                    <button onclick="alert('To-Go Selected')">To-Go</button>
                </div>
                <button class="back-btn" onclick="closePaymentModal()">Back</button>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    // 모달 열기/닫기 함수
    function openLanguageModal() { document.getElementById("languageModal").style.display = "flex"; }
    function closeLanguageModal() { document.getElementById("languageModal").style.display = "none"; }
    function openPaymentModal() { document.getElementById("paymentModal").style.display = "flex"; }
    function closePaymentModal() { document.getElementById("paymentModal").style.display = "none"; }
    // 장바구니에 추가하는 함수
    let currentLanguage = 'ko'
    function addToCart(itemId) {
        fetch(`/senior/add_to_cart/${itemId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    document.getElementById("cart").innerHTML = data.cart_html;
                    applyTranslations(languageData[currentLanguage]); // Reapply translations
                    const selectedItemElement = document.querySelector(
                        `.menu-item[data-id='${itemId}'] h2`
                    );
                    if (selectedItemElement) {
                        const selectedItem = selectedItemElement.innerText;

                    }
                } else {
                    alert("An issue occurred while adding to the cart.");
                }
            })
            .catch((error) => console.error("Error:", error));
    }



    async function fetchLanguageFromServer() {
        const response = await fetch('/get_language'); // Flask에서 현재 언어 가져오기
        const data = await response.json();
        return data.language || 'ko'; // 기본값은 'ko'
    }

    // 번역 데이터를 저장할 전역 객체
    let languageData = {}; // 초기화
    async function fetchTranslationData() {
        const response = await fetch("{{ url_for('static', filename='translation/translations.json') }}");
        languageData = await response.json(); // 번역 데이터 로드
    }
    // 페이지 로드 시 실행
    window.onload = async function () {
        await fetchTranslationData(); // 번역 데이터 초기화
        const savedLanguage = await fetchLanguageFromServer(); // Flask에서 언어 상태 가져오기
        currentLanguage = savedLanguage
        if (languageData[savedLanguage]) {
            applyTranslations(languageData[savedLanguage]); // 번역 적용
        }

    };

    // 언어 변경 함수
    async function setLanguage(lang) {
        try {
            // Flask 세션에 언어를 저장하기 위해 서버로 요청 전송
            const response = await fetch(`/set_language/${lang}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    console.log(`Language successfully set to: ${data.language}`);

                    // 글로벌 언어 상태 업데이트
                    currentLanguage = data.language;
                    sessionStorage.setItem("selectedLanguage", data.language);

                    // 번역 데이터 적용
                    if (languageData[data.language]) {
                        applyTranslations(languageData[data.language]);
                    }
                } else {
                    console.error("Failed to set language on server.");
                }
            } else {
                console.error("Error setting language. Server response:", response.status);
            }
        } catch (error) {
            console.error("Error during setLanguage:", error);
        } finally {
            // 언어 선택 모달 닫기
            closeLanguageModal();
        }
    }
    // 추천 문구를 업데이트하는 함수
    function updateRecommendations() {
        const recommendationElement = document.querySelector('.recommendation');
        if (!recommendationElement) return;
        let gender = '{{gender}}';
        let age = '{{age}}';
        let emotion = '{{emotion}}';
        let recommendationText = "";
        console.log(languageData)
        // 조건에 따라 추천 문구 설정 (예: gender, age, emotion)
        if (gender === 'male' && age === '20세 이하' && emotion === '긍정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["positive_male_young"];
        } else if (gender === 'male' && age === '20세 이하' && emotion === '부정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["negative_male_young"];
        } else if (gender === 'male' && age === '20세 이하' && emotion === '중립') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["neutral_male_young"];
        } else if (gender === 'male' && age === '20~39세' && emotion === '긍정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["positive_male_adult"];
        } else if (gender === 'male' && age === '20~39세' && emotion === '부정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["negative_male_adult"];
        } else if (gender === 'male' && age === '20~39세' && emotion === '중립') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["neutral_male_adult"];
        } else if (gender === 'male' && age === '40세 이상' && emotion === '긍정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["positive_male_senior"];
        } else if (gender === 'male' && age === '40세 이상' && emotion === '부정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["negative_male_senior"];
            console.log(recommendationText);
        } else if (gender === 'male' && age === '40세 이상' && emotion === '중립') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["neutral_male_senior"];
        } else if (gender === 'female' && age === '20세 이하' && emotion === '긍정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["positive_female_young"];
        } else if (gender === 'female' && age === '20세 이하' && emotion === '부정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["negative_female_young"];
        } else if (gender === 'female' && age === '20세 이하' && emotion === '중립') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["neutral_female_young"];
        } else if (gender === 'female' && age === '20~39세' && emotion === '긍정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["positive_female_adult"];
        } else if (gender === 'female' && age === '20~39세' && emotion === '부정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["negative_female_adult"];
        } else if (gender === 'female' && age === '20~39세' && emotion === '중립') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["neutral_female_adult"];
        } else if (gender === 'female' && age === '40세 이상' && emotion === '긍정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["positive_female_senior"];
        } else if (gender === 'female' && age === '40세 이상' && emotion === '부정') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["negative_female_senior"];
        } else if (gender === 'female' && age === '40세 이상' && emotion === '중립') {
            recommendationText = languageData[currentLanguage]["recommend_comment"]["neutral_female_senior"];
        } else {
            console.log('없데영', gender, age, emotion)
        }

        // 추천 문구 업데이트
        recommendationElement.innerText = recommendationText || "No recommendation available.";
    }



    // 번역 적용 함수
    function applyTranslations(languageData) {
        // 일반 UI 텍스트 번역
        document.querySelector(".navbar a:nth-child(1)").innerText = languageData["recommend_menu"];
        document.querySelector(".navbar a:nth-child(2)").innerText = languageData["coffee_menu"];
        document.querySelector(".navbar a:nth-child(3)").innerText = languageData["tea_menu"];
        document.querySelector(".navbar a:nth-child(4)").innerText = languageData["beverage_menu"];
        document.querySelector(".lang-btn").innerText = languageData["language_button"];
        document.querySelector("#paymentModal h2").innerText = languageData["payment_title"];
        document.querySelector("#paymentModal .payment-options button:nth-child(1)").innerText = languageData["payment_card"];
        document.querySelector("#paymentModal .payment-options button:nth-child(2)").innerText = languageData["payment_cash"];
        document.querySelector("#paymentModal .store-options button:nth-child(1)").innerText = languageData["payment_dine_in"];
        document.querySelector("#paymentModal .store-options button:nth-child(2)").innerText = languageData["payment_take_out"];

        // 이전/다음 메뉴 버튼 번역



        updateRecommendations();

        // 메뉴 항목 번역
        const menuItems = document.querySelectorAll(".menu-item h2");
        menuItems.forEach((item) => {
            const originalName = item.getAttribute("data-name");
            if (languageData["menu_items"][originalName]) {
                item.innerText = languageData["menu_items"][originalName];
            }
        });

        // 결제, 취소 버튼 번역
        document.querySelector(".payment-btn").innerText = languageData["pay_button"] || "Pay";
        document.querySelector(".cancel-btn").innerText = languageData["cancel_button"] || "Cancel";
        const cartItems = document.querySelectorAll(".cart-item-name");
        cartItems.forEach((cartItem) => {
            const originalName = cartItem.getAttribute("data-name");
            if (languageData["menu_items"][originalName]) {
                cartItem.innerText = languageData["menu_items"][originalName];
            }
        });

    }

</script>